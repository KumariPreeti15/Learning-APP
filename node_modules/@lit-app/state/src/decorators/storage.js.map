{"version":3,"file":"storage.js","sourceRoot":"","sources":["storage.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,KAAK,EAAE,MAAM,YAAY,CAAC;AACnC,OAAO,EAAE,aAAa,EAAE,MAAM,qBAAqB,CAAC;AAMpD,MAAM,cAAc,GAAmB;IACtC,MAAM,EAAE,KAAK;CACb,CAAA;AAGD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GA6BG;AACH,MAAM,UAAU,OAAO,CAAC,OAAwB;IAC/C,OAAO,GAAG,EAAE,GAAG,cAAc,EAAE,GAAG,OAAO,EAAE,CAAA;IAE3C,OAAO,CACJ,KAAY,EACZ,IAAiB,EACjB,EAAE;QACJ,MAAM,UAAU,GAAG,MAAM,CAAC,wBAAwB,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;QAChE,IAAI,CAAC,UAAU,EAAE;YAChB,MAAM,IAAI,KAAK,CAAC,4DAA4D,CAAC,CAAA;SAC7E;QACD,MAAM,GAAG,GAAW,GAAG,OAAO,EAAE,MAAM,IAAI,EAAE,IAAI,OAAO,EAAE,GAAG,IAAI,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC;QAC/E,MAAM,IAAI,GAAG,CAAC,KAAK,CAAC,CAAC,WAA2B,CAAC;QACjD,MAAM,UAAU,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;QAC9C,MAAM,IAAI,GAAG,UAAU,EAAE,IAAI,CAAA;QAC7B,IAAG,UAAU,EAAE;YACd,MAAM,aAAa,GAAG,UAAU,CAAC,YAAY,CAAA;YAC7C,UAAU,CAAC,YAAY,GAAG,GAAG,EAAE,CAAC,KAAK,CAAC,YAAY,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,IAAI,CAAC,IAAI,aAAa,CAAC,aAAa,CAAC,CAAC;YACvG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,EAAE,EAAC,GAAG,UAAU,EAAE,GAAG,OAAO,EAAC,CAAC,CAAA;SACvD;QACD,qCAAqC;QACrC,MAAM,SAAS,GAAG,UAAU,EAAE,GAAG,CAAC;QAClC,MAAM,MAAM,GAAG,UAAuB,KAAc;YACnD,IAAI,KAAK,KAAK,SAAS,EAAE;gBACxB,YAAY,CAAC,OAAO,CAAC,GAAG,EACvB,CAAC,IAAI,KAAK,MAAM;oBACf,IAAI,KAAK,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAe,CAAC,CAAC;aAC7D;YACD,IAAI,SAAS,EAAE;gBACd,SAAS,CAAC,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;aAC5B;QACF,CAAC,CAAA;QACD,MAAM,aAAa,GAAG;YACrB,GAAG,UAAU;YACb,GAAG,EAAE,MAAM;SACX,CAAC;QACF,MAAM,CAAC,cAAc,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,EAAE,aAAa,CAAC,CAAC;QAC3D,OAAO,SAAS,CAAA;IACjB,CAAC,CAAA;AACF,CAAC","sourcesContent":["\nimport {State } from '../state.js'\nimport { parse } from './parse.js';\nimport { functionValue } from '../functionValue.js';\nexport type StorageOptions = {\n\tkey?: string,\n\tprefix?: string\n}\n\nconst defaultOptions: StorageOptions = {\n\tprefix: '_ls'\n}\n\n\n/**\n * A decorator for syncing state values with localStorage\n * \n * A state property marked with @storage will read the value \n * from the associated localStorage item, parse it depending on \n * its type and make it available to the state. \n * \n * Anytime the state property changes, the change is reflected \n * to localStorage. \n * \n * A default (`_ls` for `Lit State`) prefix is set \n * \n * @storage must be placed before @property for this to work.\n * \n * How to use: \n * ```js\n * class MyState extends State {\n * \n *   @storage({key: 'storage_path'})\n *   @property({value: 1}) a;\n * }\n * const s = new S()\n * \n * localStorage.getItem('_ls_storage_path') \n *  \n * ```\n * \n * @param options \n * @returns PropertySignature\n */\nexport function storage(options?: StorageOptions) {\n\toptions = { ...defaultOptions, ...options }\n\t\n\treturn (\n    proto: State,\n    name: PropertyKey\n  ) => {\n\t\tconst descriptor = Object.getOwnPropertyDescriptor(proto, name);\n\t\tif (!descriptor) {\n\t\t\tthrow new Error('@local-storage decorator need to be called after @property')\n\t\t}\t\n\t\tconst key: string = `${options?.prefix || ''}_${options?.key || String(name)}`;\n\t\tconst ctor = (proto).constructor as typeof State;\n\t\tconst definition = ctor.propertyMap.get(name);\n\t\tconst type = definition?.type\n\t\tif(definition) {\n\t\t\tconst previousValue = definition.initialValue\n\t\t\tdefinition.initialValue = () => parse(localStorage.getItem(key), type) ?? functionValue(previousValue);\n\t\t\tctor.propertyMap.set(name, {...definition, ...options})\n\t\t}\n\t\t// const oldGetter = descriptor?.get;\n\t\tconst oldSetter = descriptor?.set;\n\t\tconst setter = function (this: State, value: unknown) {\n\t\t\tif (value !== undefined) {\n\t\t\t\tlocalStorage.setItem(key,\n\t\t\t\t\t(type === Object ||\n\t\t\t\t\t\ttype === Array) ? JSON.stringify(value) : value as string);\n\t\t\t}\n\t\t\tif (oldSetter) {\n\t\t\t\toldSetter.call(this, value);\n\t\t\t}\n\t\t}\n\t\tconst newDescriptor = {\n\t\t\t...descriptor,\n\t\t\tset: setter\n\t\t};\n\t\tObject.defineProperty(ctor.prototype, name, newDescriptor);\n\t\treturn undefined\n\t}\n}\n"]}